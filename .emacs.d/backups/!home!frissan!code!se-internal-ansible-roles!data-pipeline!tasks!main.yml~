- name: 'add python3.6 apt repository'
  apt_repository:
    repo: 'ppa:jonathonf/python-3.6'
    state: 'present'

- name: 'apt update'
  apt:
    update_cache: true

- name: Install Python 3.6
  apt: name={{ item }}
       update_cache=yes
       state=installed
  with_items:
    - python-virtualenv
    - python3.6
    - python3.6-dev
    - python3-pip

- name: Create the application user
  user: name=mqp
        state=present

- name: Create key directory
  file: path=/home/mqp/.ssh
        mode=700
        owner=mqp
        state=directory

- name: Copy ssh private key
  copy:
    content: '{{ mqp_ssh_key_priv }}'
    dest: '/home/mqp/.ssh/deploy'
    owner: 'mqp'
    group: 'mqp'
    mode: '0600'

- name: Clone mqtt pipeline
  git:
    repo: 'git@bitbucket.org:trelltech/fv-mqtt-pipeline.git'
    dest: '/home/mqp/mqtt-pipeline'
    clone: 'yes'
    update: 'yes'
    accept_hostkey: 'yes'
    version: '{{ mqp_branch | default("master") }}'
    key_file: /home/mqp/.ssh/deploy
  tags: deploy

- name: Create a python3.6 virtualenv
  command: virtualenv -p python3.6 /home/mqp/env --no-site-packages
           creates=/home/mqp/env/bin/activate

- name: Install packages required by mqtt pipeline inside virtualenv
  pip: virtualenv=/home/mqp/env
       requirements=/home/mqp/mqtt-pipeline/requirements.txt
  tags: deploy

- name: Ensure that the application file permissions are set properly
  file: path=/home/mqp/mqtt-pipeline
        recurse=yes
        owner=mqp
        group=mqp
        state=directory

- name: Create supervisor config file
  template: src=supervisor-program.j2
            dest=/etc/supervisor/conf.d/mqtt-pipeline.conf
            backup=yes
  when: application_skip_supervisor is not defined

- name: Copy mqtt config
  command: cp /home/mqp/mqtt-pipeline/config/{{ mqp_config_file }} /home/mqp/mqtt-pipeline/config/local.yml
  tags: deploy

- name: Ensure supervisor configuration is present
  supervisorctl: name=mqtt-pipeline state=present
  tags: deploy
  when: application_skip_supervisor is not defined

- name: (Re)start application
  supervisorctl: name=mqtt-pipeline state=restarted
  when: application_skip_supervisor is not defined
  tags: deploy

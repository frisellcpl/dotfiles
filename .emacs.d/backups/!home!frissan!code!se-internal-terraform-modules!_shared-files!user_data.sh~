#!/usr/bin/env bash

REPO_URL="git@bitbucket.org:trelltech/fv-configure.git"
REPO_PATH="/root/fv-configure"

APT_PACKAGES="git ansible python-apt apt-transport-https"

SSH_CONFIG="
Host bitbucket.org
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
"

PUB_KEY="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDfnMZdVMZs3Ri1oTfwbidiyVy5Wno1nYYn8rItcntuE9ySBwuPAJ7zcM5wLm7RCZ5J6EMF76kgYL7V7X1u5kWnT2YxoZUn9FbzrV2/+/g4G55t9JGmusKVsKMwt4Z+il+WpxYTdT8z6mImwAbmGV7uzi/6Vg/tQr71p5Unz68jiCvaw+G0UwCXMiAunLH0HarmlYHyaSDJlZ5eo0O6KAxvRDHVR+xKUc7hwoC1EOxL6MnBeELpc+Ijhs2W3kgw3Ux1vnpgJSFTCDzGMth87s/DCL0WKGwdKFSUwq916s17fEPSsCzuxvM1A0fktRdW4TYTl14h4nwk55+/SBWVCVYFwIduMXSMKhBiqkS4fU0oFCtD0DLOLIYC+BZNXWgtoA1PDUszFOsNvo1OxPQ1h10MYmSdVqmefEaLfs52tPkmWwRhNy+clg2CX60IlG9QdiciUF1InRKVqeSXUrvllOlP3+4PC2jdxSQ7iaQ7Ch/300ZNqYXHm372GAymf2wkVYawyL0S/RI8pofbP3+K9ByKSS9vM1vN2PIkEuM/Xp8upWlHT54HNA44YaMrS6tusXJzQcUm2evXGO/MgiYjv9Dqj3ctBUR5rEk9BD0XNj0Iog9sqosdSCsf6Y1ONG0SB/dQC6ha3rvvcRshjGRHiLswvWsnu182cZNvNA9ha8NANw== platform@fortumvarme"

PRIV_KEY="-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----"

# add platform ssh keys and config to root user
mkdir -p "/root/.ssh"
echo "$SSH_CONFIG" > "/root/.ssh/config"
echo "$PUB_KEY" > "/root/.ssh/id_rsa.pub"
echo "$PRIV_KEY" > "/root/.ssh/id_rsa"
chmod 600 "/root/.ssh/id_rsa"

# also add platform key as authorized key to ubuntu user
# to enable logging in and looking at logs in case ansible fails
mkdir -p "/home/ubuntu/.ssh/"
echo "$PUB_KEY" > "/home/ubuntu/.ssh/authorized_keys"
chown -R "ubuntu:ubuntu" "/home/ubuntu/.ssh"

# install apt packages
apt-get update
apt-get install -y $APT_PACKAGES

# clone repo
git clone "$REPO_URL" "$REPO_PATH"

# install roles
"$REPO_PATH/install_roles.sh" --environment "${environment}"

# run playbook
cd "$REPO_PATH"
"./${playbook}.yml" --inventory "./inventories/${environment}/hosts"
